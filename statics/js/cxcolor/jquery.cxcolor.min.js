;(function(){
	
	$.fn.cxColor = function(settings){
		
		if(this.length<1) return;
		
		settings=$.extend({},settings);
		
		this.each(function(){
			if($(this).val()){
				$(this).css({backgroundColor:$(this).val()});
			}
		})
		
		var $panel = $("<div></div>",{"class":"cxcolor"}).appendTo("body");
		
		// 初始化选择器面板
		var _color = ["00","33","66","99","cc","ff"];
		var sp_color = ["ff0000","00ff00","0000ff","ffff00","00ffff","ff00ff"];
		
		var handle_html = '<div class="panel_hd"><a class="reset" href="javascript:;">默认颜色</a><a class="clear" href="javascript:;">清除</a></div>';
		
		var _block = "";
		for(var i=0;i<2;i++){
			for(var j=0;j<6;j++){
				_block+="<tr>";
				_block+="<td title='#000000' style='background-color:#000000'>";
				if(i==0){
					_block+="<td title='#"+_color[j]+_color[j]+_color[j]+"' style='background-color:#"+_color[j]+_color[j]+_color[j]+"'>";
				}else{
					_block+="<td title='#"+sp_color[j]+"' style='background-color:#"+sp_color[j]+"'>";
				};
				_block+="<td title='#000000' style='background-color:#000000'>";
				for(var k=0;k<3;k++){
					for(var l=0;l<6;l++){
						_block+="<td title='#"+_color[k+i*3]+_color[l]+_color[j]+"' style='background-color:#"+_color[k+i*3]+_color[l]+_color[j]+"'>";
					};
				};
			};
		};
		var $table = $("<table></table>").html(_block);
		$panel.append(handle_html);
		$panel.append($table);
		
		// 背景遮挡层
		lock_bg=$("<div></div>",{"class":"cxcolor_lock"}).appendTo("body");
		
		var $obj;
		
		this.live('click',function(e){
			
			var win_w = document.body.clientWidth;
			var win_h = document.body.clientHeight;
			var $p_w = $panel.outerWidth();
			var $p_h = $panel.outerHeight();
			var $p_t = $(this).offset().top;
			var $p_l = $(this).offset().left;
			var $w = $(this).outerWidth();
			var $h = $(this).outerHeight();
			
			if(($p_t+$p_h+$h) > win_h){
				$p_t = $p_t-$p_h;
			}else{
				$p_t = $p_t+$h;
			}
			
			if(($p_l+$p_w) > win_w){
				$p_l = $p_l-($p_w-$w);
			}
			
			$panel.css({"top":$p_t,"left":$p_l}).show();

			$obj = $(this);
			
			e.stopPropagation();
		});
		
		$(window).on('click',function(){
			$panel.hide();
		})
		
		$table.find('td').on('click',function(){
			$obj.val($(this).attr("title")).css({backgroundColor:$(this).attr("title")});
		})
		
	}
	
})(jQuery);
